package com.example.project;

import java.io.*;
import java.util.Arrays;
import com.google.gson.Gson;
import com.google.gson.JsonObject;
import com.google.gson.JsonArray;
 
public class SensitiveFun {
    private static final Gson gson = new Gson();

    // Define a private static class for the response structure
    private static class Response {
        String status;
        {% if return_type == 'byte[]' %}
        JsonArray data;
        {% else %}
        {{ return_type }} data;
        {% endif %}
        String error_message;
    }
 
    public static {{ return_type }} {{ function_name }}({{ signature_params }}) {
        try {
            {% for param_name, param_type in arguments.items() %}
            {% if param_type == 'byte[]' %}
            if ({{ param_name }} == null) {
                throw new Exception("Input byte array '{{ param_name }}' cannot be null");
            }
            {% endif %}
            {% endfor %}
            String[] cmd = {"cargo", "run", "--quiet"};
            ProcessBuilder pb = new ProcessBuilder(cmd);
            pb.directory(new File("rust"));
            Process process = pb.start();
            JsonObject request = new JsonObject();
            
            request.addProperty("function_name", "{{ snake_case_function_name }}");

            JsonObject params = new JsonObject();
            {% for param_name, param_type in arguments.items() %}
            {% if param_type == 'byte[]' %}
            JsonArray {{ param_name }}Array = new JsonArray();
            for (byte b : {{ param_name }}) {
                {{ param_name }}Array.add(b & 0xFF);
            }
            params.add("{{ param_name }}", {{ param_name }}Array);
            {% elif param_type in ['int', 'Integer', 'long', 'Long', 'double', 'Double', 'float', 'Float', 'boolean', 'Boolean', 'String'] %}
            params.addProperty("{{ param_name }}", {{ param_name }});
            {% else %}
            params.add("{{ param_name }}", gson.toJsonTree({{ param_name }}));
            {% endif %}
            {% endfor %}
            request.add("params", params);

            // Send JSON request to Rust binary
            String jsonRequest = gson.toJson(request);
            OutputStream os = process.getOutputStream();
            os.write(jsonRequest.getBytes());
            os.close();
            
            // Read the JSON result from Rust binary
            InputStream is = process.getInputStream();
            StringBuilder result = new StringBuilder();
            int ch;
            while ((ch = is.read()) != -1) {
                result.append((char) ch);
            }
            is.close();
            
            // Parse the JSON response
            Response response = gson.fromJson(result.toString().trim(), Response.class);
            if ("error".equals(response.status)) {
                throw new RuntimeException("Rust function error: " + response.error_message);
            }
            
            // Wait for process to complete
            int exitCode = process.waitFor();
            if (exitCode != 0) {
                throw new RuntimeException("Rust process failed with exit code: " + exitCode);
            }
            
            {% if return_type == 'byte[]' %}
            JsonArray dataArray = response.data;
            byte[] data = new byte[dataArray.size()];
            for (int i = 0; i < dataArray.size(); i++) {
                data[i] = dataArray.get(i).getAsByte();
            }
            return data;
            {% else %}
            return response.data;
            {% endif %}
            
        } catch (Exception e) {
            throw new RuntimeException("Failed to call Rust {{ function_name }} function", e);
        }
    }
}